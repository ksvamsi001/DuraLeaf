{% extends "base.html" %}

{% block content %}
<!-- Load Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12">
    
    <!-- Banner -->
    <div class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-[2rem] p-8 mb-10 border border-green-100 flex flex-col md:flex-row items-center justify-between relative overflow-hidden">
        <div class="relative z-10 max-w-2xl">
            <div class="flex items-center gap-3 mb-4">
                <span class="bg-green-200 text-green-800 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">Farming Partner</span>
                <span class="text-green-600 text-sm font-medium"><i class="fas fa-calendar-check mr-1"></i> Weekly Checkup Reminder</span>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">We are here to help you grow.</h2>
            <p class="text-gray-600 text-lg leading-relaxed mb-6">
                Healthy crops mean a healthy future. Remember to inspect your field regularly. 
                <strong class="text-green-700">A weekly scan with DuraLeaf</strong> can prevent 80% of potential yield loss.
            </p>
            <div class="flex gap-4">
                <div class="flex items-center gap-2 text-sm font-semibold text-gray-500">
                    <div class="w-2 h-2 bg-green-500 rounded-full"></div> 24/7 AI Support
                </div>
                <div class="flex items-center gap-2 text-sm font-semibold text-gray-500">
                    <div class="w-2 h-2 bg-blue-500 rounded-full"></div> Instant Diagnosis
                </div>
            </div>
        </div>
        <div class="hidden md:block relative z-10">
            <img src="https://cdn-icons-png.flaticon.com/512/628/628283.png" alt="Farmer" class="h-48 w-auto opacity-90 drop-shadow-xl">
        </div>
    </div>

    
    
    <!-- Upload Section -->
    <div class="bg-green-700 rounded-[2rem] p-6 md:p-12 text-white shadow-2xl mb-8 relative overflow-hidden">
        <div class="relative z-10">
            <h1 class="text-2xl md:text-4xl font-bold mb-3">Ready to scan, {{ user.username }}?</h1>
            <p class="text-green-100 text-sm md:text-base mb-8 max-w-xl">Upload a clear photo of a leaf.</p>
            
            <form action="{{ url_for('analyze') }}" method="POST" enctype="multipart/form-data" class="bg-white p-2 rounded-3xl flex flex-col md:flex-row items-center w-full max-w-lg shadow-lg gap-2 md:gap-0">
                <input type="file" name="file" accept="image/*" required class="w-full ml-2 text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                <button type="submit" class="w-full md:w-auto bg-green-600 hover:bg-green-700 text-white rounded-full px-8 py-3 font-bold transition">Scan Now</button>
            </form>
        </div>
        <i class="fas fa-camera absolute -bottom-10 -right-10 text-9xl text-green-600 opacity-30 transform -rotate-12"></i>
    </div>

    <!-- History Dropdown -->
    <div class="mb-4">
        <button onclick="toggleHistory()" class="w-full bg-white border border-gray-200 hover:border-green-300 rounded-2xl p-4 flex items-center justify-between shadow-sm hover:shadow-md transition group">
            <div class="flex items-center gap-3">
                <div class="bg-green-100 text-green-600 p-2 rounded-lg group-hover:bg-green-600 group-hover:text-white transition">
                    <i class="fas fa-history text-xl"></i>
                </div>
                <span class="font-bold text-gray-800 text-lg">Research History</span>
                {% if history %}
                    <span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-xs font-bold">{{ history|length }} Scans</span>
                {% endif %}
            </div>
            <i id="history-arrow" class="fas fa-chevron-down text-gray-400 transition-transform duration-300"></i>
        </button>
    </div>

    <div id="history-dropdown" class="hidden transition-all duration-500 ease-in-out overflow-hidden">
        {% if history %}
        <div class="bg-white shadow-sm rounded-2xl border border-gray-100 overflow-hidden mb-12">
            <div class="px-6 py-4 border-b border-gray-50 flex justify-between items-center bg-gray-50/50">
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">Recent Analysis</span>
                <form action="{{ url_for('clear_history') }}" method="POST" onsubmit="return confirm('Are you sure?')">
                    <button type="submit" class="text-red-500 hover:text-red-700 text-xs font-bold flex items-center gap-1 transition"><i class="fas fa-trash-alt"></i> Clear All</button>
                </form>
            </div>
            <ul class="divide-y divide-gray-50">
                {% for scan in history %}
                <li class="hover:bg-green-50/30 transition p-4 group">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                        <div class="flex items-center w-full">
                            <img class="h-12 w-12 rounded-xl object-cover border border-gray-200 mr-4 flex-shrink-0" src="{{ url_for('static', filename='uploads/' + scan.filename) }}" alt="">
                            <div class="min-w-0 flex-grow">
                                <p class="text-sm md:text-base font-bold text-gray-900 truncate">{{ scan.disease_name.replace('_', ' ') }}</p>
                                <div class="flex items-center gap-3 text-xs md:text-sm text-gray-500 mt-0.5">
                                    <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-md font-semibold">{{ "%.0f"|format(scan.confidence) }}% Conf.</span>
                                    <span>Sev: {{ "%.1f"|format(scan.severity) }}%</span>
                                </div>
                            </div>
                            <div class="hidden sm:flex items-center gap-4 ml-auto">
                                <span class="text-xs text-gray-400">{{ scan.date_posted.strftime('%Y-%m-%d') }}</span>
                                <form action="{{ url_for('delete_scan', scan_id=scan.id) }}" method="POST" onsubmit="return confirm('Delete?')">
                                    <button type="submit" class="w-8 h-8 rounded-full bg-white border border-gray-200 text-gray-400 hover:bg-red-50 hover:border-red-200 hover:text-red-500 flex items-center justify-center transition"><i class="fas fa-trash"></i></button>
                                </form>
                            </div>
                        </div>
                        <div class="flex sm:hidden justify-between items-center border-t border-gray-100 pt-2 mt-1">
                            <span class="text-xs text-gray-400">{{ scan.date_posted.strftime('%Y-%m-%d') }}</span>
                            <form action="{{ url_for('delete_scan', scan_id=scan.id) }}" method="POST" onsubmit="return confirm('Delete?')">
                                <button type="submit" class="text-red-400 hover:text-red-600 text-sm"><i class="fas fa-trash"></i> Delete</button>
                            </form>
                        </div>
                    </div>
                </li>
                {% endfor %}
            </ul>
        </div>
        {% else %}
        <div class="text-center py-8 bg-white rounded-2xl border-2 border-dashed border-gray-200 mb-8">
            <p class="text-gray-400 font-medium text-sm">No history yet.</p>
        </div>
        {% endif %}
    </div>
    <!-- Charts Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
        <!-- Chart 1: Global Trends (Static Mock Data) -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-line text-blue-500 mr-2"></i> Global Crop Health Index
            </h3>
            <div class="relative h-64 w-full">
                <canvas id="healthChart"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-4 text-center">Simulated data based on long-term agricultural trends.</p>
        </div>

        <!-- Chart 2: User History (Dynamic) -->
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-gray-100">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-pie text-orange-500 mr-2"></i> Your Disease Distribution
            </h3>
            <div class="relative h-64 w-full flex items-center justify-center">
                <canvas id="diseaseChart"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-4 text-center">Distribution of diseases detected in your history.</p>
        </div>
    </div>
</div>

<!-- FLOATING CHATBOT -->
<div class="fixed bottom-5 right-5 z-40">
    <div id="chat-window" class="hidden bg-white w-[90vw] md:w-96 rounded-2xl shadow-2xl border border-gray-200 overflow-hidden transition-all transform origin-bottom-right mb-16 md:mb-0">
        <div class="bg-green-600 p-4 flex justify-between items-center text-white">
            <div class="flex items-center gap-2"><i class="fas fa-robot"></i><h3 class="font-bold text-sm">DuraLeaf Helper</h3></div>
            <button onclick="toggleChat()" class="hover:bg-green-700 p-1 rounded"><i class="fas fa-times"></i></button>
        </div>
        <div id="chat-box" class="h-72 p-4 overflow-y-auto bg-gray-50 space-y-3 text-sm">
            <div class="bg-white border border-gray-200 p-3 rounded-br-xl rounded-bl-xl rounded-tr-xl inline-block shadow-sm text-gray-700">
                Hello! Ask me about crops, soil, or weather.
            </div>
        </div>
        <div class="p-3 border-t border-gray-100 bg-white flex gap-2">
            <input type="text" id="user-input" class="flex-grow px-4 py-2 border border-gray-200 rounded-full text-sm focus:outline-none focus:border-green-500" placeholder="Type a question..." onkeypress="handleEnter(event)">
            <button onclick="sendMessage()" class="bg-green-600 text-white w-10 h-10 rounded-full flex items-center justify-center hover:bg-green-700 shadow-md transition flex-shrink-0"><i class="fas fa-paper-plane text-xs"></i></button>
        </div>
    </div>
    <button id="chat-trigger" onclick="toggleChat()" class="bg-green-600 hover:bg-green-700 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center transition transform hover:scale-110"><i class="fas fa-comment-dots text-2xl"></i></button>
</div>

<script>
    // --- TOGGLE HISTORY ---
    function toggleHistory() {
        const dropdown = document.getElementById('history-dropdown');
        const arrow = document.getElementById('history-arrow');
        if (dropdown.classList.contains('hidden')) {
            dropdown.classList.remove('hidden');
            arrow.classList.add('rotate-180');
        } else {
            dropdown.classList.add('hidden');
            arrow.classList.remove('rotate-180');
        }
    }

    // --- CHARTS LOGIC ---
    document.addEventListener('DOMContentLoaded', function() {
        // 1. Health Chart (Static)
        const ctx1 = document.getElementById('healthChart').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [{
                    label: 'Crop Yield Health',
                    data: [65, 78, 75, 82, 85, 90],
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });

        // 2. Disease Chart (DYNAMIC)
        initDiseaseChart();
    });

    async function initDiseaseChart() {
        const ctx2 = document.getElementById('diseaseChart').getContext('2d');
        const colors = ['#10b981', '#ef4444', '#f59e0b', '#3b82f6', '#8b5cf6', '#ec4899', '#f97316'];

        try {
            // Fetch real data from your API
            const response = await fetch('{{ url_for("chart_data") }}');
            const data = await response.json();

            let chartData, chartLabels, chartColors;

            if (data.labels && data.labels.length > 0) {
                chartLabels = data.labels.map(l => l.replace(/___/g, ' ').replace(/__/g, ' '));
                chartData = data.counts;
                chartColors = chartLabels.map((_, i) => colors[i % colors.length]);
            } else {
                // Fallback if no history yet
                chartLabels = ['No Data Yet'];
                chartData = [1];
                chartColors = ['#e5e7eb'];
            }

            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        data: chartData,
                        backgroundColor: chartColors,
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: { 
                        legend: { 
                            position: 'bottom', 
                            labels: { boxWidth: 12, font: { size: 10 } } 
                        } 
                    } 
                }
            });
        } catch (e) {
            console.error("Chart Error:", e);
        }
    }

    // --- CHAT LOGIC ---
    function toggleChat() {
        const window = document.getElementById('chat-window');
        if (window.classList.contains('hidden')) {
            window.classList.remove('hidden');
            setTimeout(() => document.getElementById('user-input').focus(), 100);
        } else {
            window.classList.add('hidden');
        }
    }

    function handleEnter(e) { if (e.key === 'Enter') sendMessage(); }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const chatBox = document.getElementById('chat-box');
        const message = input.value.trim();
        if(!message) return;

        chatBox.innerHTML += `<div class="flex justify-end"><div class="bg-green-600 text-white p-3 rounded-tl-xl rounded-tr-xl rounded-bl-xl inline-block shadow-sm max-w-[85%]">${message}</div></div>`;
        input.value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        // Loading State
        const loadId = 'load-' + Date.now();
        chatBox.innerHTML += `<div id="${loadId}" class="flex justify-start"><div class="bg-white border p-3 rounded-br-xl rounded-bl-xl rounded-tr-xl inline-block text-gray-400"><i class="fas fa-circle-notch fa-spin"></i></div></div>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const response = await fetch('/chat_api', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: message })
            });
            const data = await response.json();
            document.getElementById(loadId).remove();
            chatBox.innerHTML += `<div class="flex justify-start"><div class="bg-white border border-gray-200 text-gray-700 p-3 rounded-br-xl rounded-bl-xl rounded-tr-xl inline-block shadow-sm max-w-[90%]">${data.reply}</div></div>`;
        } catch(err) {
            document.getElementById(loadId).remove();
            chatBox.innerHTML += `<div class="flex justify-start text-xs text-red-400 p-2">Connection error.</div>`;
        }
        chatBox.scrollTop = chatBox.scrollHeight;
    }
</script>
{% endblock %}